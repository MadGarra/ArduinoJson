<!DOCTYPE html>
<html>
<head>
    <title>ArduinoJson - JsonBuffer size calculator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>JsonBuffer size calculator</h1>
        </div>
        <div id='error' class="alert alert-danger" role="alert">
            Please paste your JSON in the "input" box
        </div>
        <div class="row">
            <div class="col-md-6">
                <h2>Input</h2>
                <textarea class="form-control" rows=30 id='input'></textarea><br>
            </div>
            <div id='results' class="col-md-6" style='display:none'>
                <h2>Result</h2>
                <h3>Expression</h3>
                <p><code id='$result_expr'></code></p>
                <table class="table">
                  <thead>
                    <th>Platform</th>
                    <th>Size (in bytes)</th>
                  </thead>
                  <tbody id='$result_table'>
                  </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    var architectures = [
      {
        "name": "AVR 8-bit",
        "array": {
          "base": 4,
          "item": 8
        },
        "object": {
          "base": 4,
          "item": 10
        }
      },
      {
        "name": "ESP8266",
        "array": {
          "base": 8,
          "item": 12
        },
        "object": {
          "base": 8,
          "item": 16
        }
      },
      {
        "name": "Visual Studio x86",
        "array": {
          "base": 12,
          "item": 24
        },
        "object": {
          "base": 12,
          "item": 32
        }
      },
      {
        "name": "Visual Studio x64",
        "array": {
          "base": 24,
          "item": 24
        },
        "object": {
          "base": 24,
          "item": 32
        }
      }
    ];

    function Recipe() {
        var arrays = [];
        var objects = [];

        this.addJsonArray = function(size) {
            if (arrays[size])
                arrays[size]++;
            else
                arrays[size] = 1;
        }

        this.addJsonObject = function(size) {
            if (objects[size])
                objects[size]++;
            else
                objects[size] = 1;
        }

        this.getExpression = function() {
            var elements = [];
            for (var size in arrays) {
                var count = arrays[size];
                if (count > 1)
                    elements.push(count + "*JSON_ARRAY_SIZE("+size+")");
                else
                    elements.push("JSON_ARRAY_SIZE("+size+")");
            }
            for (var size in objects) {
                var count = objects[size];
                if (count > 1)
                    elements.push(count + "*JSON_OBJECT_SIZE("+size+")");
                else
                    elements.push("JSON_OBJECT_SIZE("+size+")");
            }
            return elements.join(" + ");
        }

        this.computeSize = function(arch) {
            var totalBytes = 0;
            for (var size in arrays) {
                var count = arrays[size];
                totalBytes += count*(arch.array.base + size*arch.array.item);
            }
            for (var size in objects) {
                var count = objects[size];
                totalBytes += count*(arch.object.base + size*arch.object.item);
            }
            return totalBytes;
        }
    }

    function scanJson(recipe, obj) {
        if (obj instanceof Array) {
            recipe.addJsonArray(obj.length);
            for (var i = 0; i<obj.length; i++)
                scanJson(recipe, obj[i]);
        }
        else if (obj instanceof Object) {
            recipe.addJsonObject(Object.keys(obj).length);
            for (var key in obj) 
                scanJson(recipe, obj[key]);
        }
    }

    input.oninput = function(e) {
        results.style.display = 'none';
        error.style.visibility = 'hidden';

        try {
            var recipe = new Recipe();
            scanJson(recipe, JSON.parse(input.value));
            var expression = recipe.getExpression();

            $result_expr.innerText = expression;

            for (var i=0; i<architectures.length; i++) {
                var arch = architectures[i];
                var row = $result_table.rows[i] || $result_table.insertRow(i);
                var name_cell = row.cells[0] || row.insertCell(0);
                var size_cell = row.cells[1] || row.insertCell(1);
                name_cell.innerText = arch.name;
                size_cell.innerText = recipe.computeSize(arch);
            }
            results.style.display = 'block';
        }
        catch (ex) {
            error.innerText = "ERROR: " + ex.message;
            error.style.visibility = 'visible';
        }
    }
</script>
</html>
